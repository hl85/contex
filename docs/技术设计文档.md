
# 技术设计文档 (Technical Design Document)

**项目名称：** Contex (Container + Context, 隐喻cortex)

## 1. 系统概述 (System Overview)

### 1.1 设计目标

构建一套**本地优先 (Local-First)** 的个人 AI 生产力平台，旨在解决以下核心矛盾：

1. **能力与隐私的矛盾：** 在保障用户数据（文档、凭证）不离开本地的前提下，提供强大的 AI 处理能力。
2. **隔离与交互的矛盾：** 通过容器技术保障运行环境的纯净与稳定，同时打破沙盒限制，实现对宿主机资源的受控访问。
3. **本地与远程的矛盾：** 在无公网 IP 的家庭网络环境下，实现合规、低延迟的远程控制（通过微信/Telegram）。

### 1.2 核心业务场景支持

* **自动化信息处理：** 每日定时抓取、分析、推送简报。
* **即时任务执行：** 远程接收指令，生成代码，并在本地即时部署 Web 服务供外部访问。
* **本地数据作业：** 对宿主机的敏感文件（Excel/PDF）进行深度分析与处理。

---

## 2. 系统架构设计 (System Architecture)

系统遵循**分层架构 (Layered Architecture)** 原则，将表现层、控制层、执行层与网关层解耦。

### 2.1 架构分层视图

| 层级 | 组件名称 | 技术选型 | 核心职责 |
| --- | --- | --- | --- |
| **L1: 表现与交互层** | **Client Wrapper** | Tauri (Rust + React) | 桌面端 GUI，负责安装引导、进程守护、配置管理。 |
| **L2: 桥接与控制层** | **Sidecar Service** | Python (FastAPI) | 宿主机驻留服务。负责协议转换、权限守门、远程信令中转。 |
| **L3: 核心执行层** | **Brain Container** | Docker (Linux) | 业务逻辑闭环。包含运行时环境、工具链、任务编排器。 |
| **L4: 远程网关层** | **Remote Gateway** | 微信小程序 / Telegram Mini App | 移动端入口。负责用户鉴权、指令下发、结果渲染。 |

---

## 3. 核心模块详细设计 (Component Design)

### 3.1 客户端外壳 (Desktop Wrapper)

以“开箱即用”为首要设计原则，屏蔽底层容器技术的复杂度。

* **生命周期管理：**
* 启动时自动检测 Docker Desktop 状态。
* 静默启动/停止 Sidecar 服务与 Docker 容器。
* 处理应用自动更新。


* **配置管理：**
* 提供可视化界面配置环境变量（如 API Keys）。
* 管理宿主机挂载目录（Mount Volumes）的白名单。



### 3.2 桥接服务 (Sidecar Service)

作为连接容器内部（隔离区）与宿主机（非隔离区）的唯一枢纽，承担**系统总线**的角色。

* **协议实现 (Protocol Implementation):**
* 采用 **MCP (Model Context Protocol)** 标准定义宿主机能力接口（如 `fs_read`, `open_app`）。
* *设计理由：* 遵循行业标准，便于未来接入第三方工具，而非重复造轮子。


* **安全守门 (Security Guard):**
* **文件系统拦截：** 拦截所有文件读写请求，校验路径是否在用户授权的白名单内。
* **高危操作确认：** 对于敏感指令（如删除文件、对外端口映射），触发桌面端弹窗确认。


* **网络隧道 (Network Tunneling):**
* 集成反向代理功能，将容器内的临时 Web 服务端口映射为公网可访问的 HTTPS 链接（用于远程查看生成结果）。



### 3.3 执行容器 (Execution Container)

采用 **"All-in-One" (全栈预置)** 策略构建镜像，确保环境的一致性与高可用性。

* **基础环境 (Runtime Environment):**
* **Python 3.12:** 提供高性能的异步计算与逻辑推理能力。支持 `pip install --user` 动态安装依赖。
* **Node.js 22 LTS:** 提供稳定的 Web 服务支持与前端构建能力。支持 `npm install -g` (配置为用户目录)。
* **Process Manager:** 内置 **PM2** 或 **Supervisord**，允许 Agent 以后台模式启动 Web 服务并获取 stdout/stderr 日志，避免阻塞主进程。


* **生产力工具链 (Productivity Toolchain):**
* **Code Server:** 内置 VS Code 后端，支持代码编辑与调试。
* **Dev Tools:** 预置 **Git** (版本控制), **Black/ESLint** (代码格式化), **Curl/Httpie** (自测工具)。
* **Browser Engine:** 预置 Playwright (Chromium)，支持无头浏览与网页自动化。
* **Data Suite:** 预置 Pandas, NumPy, JupyterLab，支持本地数据分析。


* **任务编排器 (Orchestrator):**
* 采用 **LangGraph** 或同类图编排框架，管理长链路任务的状态流转与异常重试。



### 3.4 远程接入 (Remote Access)

利用微信/Telegram 生态解决复杂的内网穿透与身份验证问题。

* **通信链路：**
* **控制流：** 小程序 -> 微信/Telegram 云托管 -> (WebSocket 长连接) -> 本地 Sidecar -> 容器。
* **数据流：** 容器生成结果 -> Sidecar -> 云托管 (HTTPS) -> 小程序渲染。


* **合规性设计：**
* 所有流量经过微信/Telegram 云托管中转，无需用户配置动态域名 (DDNS) 或开放路由器端口。



---

## 4. 关键流程设计 (Key Workflows)

### 4.1 本地与宿主机交互流程 (Local Interaction)

*场景：容器内的 Agent 需要读取桌面上的 Excel 文件。*

1. **Request:** 容器内业务代码发起标准 MCP 请求 `call_tool("fs_read", path="~/Desktop/data.xlsx")`。
2. **Transport:** 请求通过 Docker 内部网络 (`host.docker.internal`) 发送至 Sidecar。
3. **Validation:** Sidecar 拦截请求，校验 `~/Desktop/` 是否在允许列表中。
4. **Execution:** 校验通过，Sidecar 调用宿主机 OS API 读取文件流。
5. **Response:** 文件数据流返回给容器，Agent 接手处理。

### 4.2 远程指令执行流程 (Remote Execution)

*场景：用户在微信或 Telegram 要求“生成一个演示网页并上线”。*

1.  **Ingest:** 微信云托管或 Cloud Relay 接收指令，通过 WebSocket 推送至 Sidecar。
2. **Dispatch:** Sidecar 将指令载荷转发给容器内的编排器。
3. **Process:**
* 容器生成 HTML/JS 代码。
* 容器调用 Process Manager (PM2) 启动 HTTP Server (e.g., Port 54321)，并即时通过 `curl` 自测服务可用性。


4. **Expose (关键步骤):**
* 容器请求 Sidecar 执行 `tunnel_expose(local_port=54321)`。
* Sidecar 建立隧道，获取公网 URL (e.g., `https://proxy.contex.com/s/xyz`)。


5. **Feedback:** Sidecar 将公网 URL 封装为卡片消息，回推至微信。

---

## 5. 数据与安全设计 (Data & Security)

### 5.1 数据主权 (Data Sovereignty)

* **本地存储：** 核心业务数据、代码库、知识库仅持久化存储于用户本地磁盘（通过 Docker Volume 挂载）。
* **零知识云端：** 微信云托管仅作为**加密通道**传输指令与结果，不存储用户业务数据的副本。

### 5.2 权限控制模型 (Permission Model)

系统实施**最小权限原则 (Least Privilege)**：

* **网络隔离：** 容器默认仅加入特定的 Docker Bridge 网络。
* **身份验证：** 容器与 Sidecar 之间通过启动时生成的 `SessionToken` 进行双向鉴权，防止恶意程序调用 Sidecar 接口。

---

## 6. 部署与交付 (Deployment & Delivery)

### 6.1 发布形式

* **macOS:** `.dmg` 安装包 (Universal Binary)。
* **Windows:** `.exe` 安装包 (NSIS)。

### 6.2 初始化策略

应用采用**自包含引导 (Self-Contained Bootstrap)** 策略：

1. **环境检查：** 启动时检测 Docker 环境，若缺失则引导用户安装。
2. **镜像拉取：** 首次运行自动拉取优化后的生产镜像。
3. **无感升级：** 桌面端检测到新版本时，自动拉取新镜像并平滑重启容器，用户数据通过挂载卷保留。

---

## 7. 总结 (Conclusion)

本架构设计文档以**其实用性与稳定性**为核心，通过标准化的容器技术解决环境依赖问题，通过 Sidecar 模式解决系统交互问题，通过微信生态解决远程连接问题。MCP 与 Skill 技术在此架构中被合理地安置于**接口层**与**逻辑层**，作为实现手段而非目的，共同服务于“构建个人本地 AI 生产力平台”这一最终产品目标。